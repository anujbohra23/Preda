{% extends 'base.html' %}
{% block title %}Condition Matching Results{% endblock %}

{% block content %}

{# Breadcrumb #}
<div class="mb-5 text-sm text-slate-500 flex items-center gap-2">
  <a href="{{ url_for('sessions.dashboard') }}"
     class="text-blue-600 hover:underline">Dashboard</a>
  <span>/</span>
  <a href="{{ url_for('sessions.detail', session_id=session.id) }}"
     class="text-blue-600 hover:underline">{{ session.title }}</a>
  <span>/</span>
  <span>Results</span>
</div>

{# â”€â”€ Page header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="flex items-start justify-between mb-6 gap-4">
  <div>
    <h1 class="text-2xl font-bold text-slate-800 mb-1">
      Condition Matching Results
    </h1>
    <p class="text-sm text-slate-500">
      Top {{ results | length }} informational matches based on your symptoms.
      These are <strong>not diagnoses</strong>.
    </p>
  </div>

  <div class="flex gap-2 shrink-0">
    {# Re-run button #}
    <form method="POST"
          action="{{ url_for('retrieve.rerun', session_id=session.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit"
              class="text-xs bg-white border border-slate-300 hover:bg-slate-50
                     text-slate-600 px-3 py-1.5 rounded-md transition-colors">
        ğŸ”„ Re-run
      </button>
    </form>

    <a href="{{ url_for('chat.chat_page', session_id=session.id) }}"
       class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold
              px-3 py-1.5 rounded-md transition-colors">
      ğŸ’¬ Ask Questions â†’
    </a>
  </div>
</div>

{# â”€â”€ Disclaimer banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 mb-6
            text-sm text-blue-800">
  <strong>â„¹ How to read these results:</strong>
  The match score shows how much your symptom description overlaps with
  each condition's typical presentation. A high score does <em>not</em>
  mean you have that condition. Many conditions share symptoms.
  Always discuss results with a qualified healthcare professional.
</div>

{% if results %}

{# â”€â”€ Intake summary pill row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="flex flex-wrap gap-2 mb-6 text-xs">
  {% if intake.get('chief_complaint') %}
  <span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full">
    ğŸ©º {{ intake.chief_complaint[:60] }}{% if intake.chief_complaint|length > 60 %}â€¦{% endif %}
  </span>
  {% endif %}
  {% if intake.get('age') %}
  <span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full">
    Age {{ intake.age }}
  </span>
  {% endif %}
  {% if intake.get('sex') %}
  <span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full">
    {{ intake.sex | capitalize }}
  </span>
  {% endif %}
  {% if intake.get('duration') %}
  <span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full">
    â± {{ intake.duration }}
  </span>
  {% endif %}
  {% if has_upload %}
  <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full">
    ğŸ“„ Document included
  </span>
  {% endif %}
</div>

{# â”€â”€ Results list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="space-y-4">
  {% for r in results %}
  <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-5
              hover:border-blue-300 transition-colors">

    {# Header row #}
    <div class="flex items-start justify-between gap-4 mb-3">
      <div class="flex items-start gap-3">

        {# Rank badge #}
        <div class="shrink-0 w-8 h-8 rounded-full flex items-center
                    justify-center text-sm font-bold
                    {% if r.rank == 1 %}bg-blue-600 text-white
                    {% elif r.rank <= 3 %}bg-blue-100 text-blue-700
                    {% else %}bg-slate-100 text-slate-500{% endif %}">
          {{ r.rank }}
        </div>

        <div>
          <h3 class="font-semibold text-slate-800 text-base leading-tight">
            {{ r.disease_name }}
          </h3>
          {% if r.icd_code %}
          <span class="text-xs text-slate-400">ICD: {{ r.icd_code }}</span>
          {% endif %}
        </div>
      </div>

      {# Score badge #}
      <div class="shrink-0 text-right">
        <div class="text-lg font-bold
                    {% if r.similarity_score > 0.3 %}text-blue-600
                    {% elif r.similarity_score > 0.15 %}text-amber-600
                    {% else %}text-slate-400{% endif %}">
          {{ (r.similarity_score * 100) | round(1) }}%
        </div>
        <div class="text-xs text-slate-400">match</div>
      </div>
    </div>

    {# Score bar #}
    <div class="w-full bg-slate-100 rounded-full h-1.5 mb-3">
      <div class="h-1.5 rounded-full
                  {% if r.similarity_score > 0.3 %}bg-blue-500
                  {% elif r.similarity_score > 0.15 %}bg-amber-400
                  {% else %}bg-slate-300{% endif %}"
           style="width: {{ [r.similarity_score * 100 * 2, 100] | min | round }}%">
      </div>
    </div>

    {# Description #}
    {% if r.short_desc %}
    <p class="text-sm text-slate-600 mb-3 leading-relaxed">
      {{ r.short_desc }}
    </p>
    {% endif %}

    {# Matching terms #}
    {% if r.matching_phrases %}
    <div class="mb-3">
      <span class="text-xs font-semibold text-slate-400 uppercase
                   tracking-wide mr-2">Matched terms:</span>
      {% for phrase in r.matching_phrases %}
        <span class="match-highlight">{{ phrase }}</span>
      {% endfor %}
    </div>
    {% endif %}

    {# Field contributions #}
    {% if r.field_contributions %}
    <div class="bg-slate-50 rounded-lg p-3">
      <p class="text-xs font-semibold text-slate-400 uppercase
                tracking-wide mb-2">What drove this match:</p>
      <div class="space-y-1.5">
        {% for field, pct in r.field_contributions.items() %}
        {% if pct > 0 %}
        <div class="flex items-center gap-2">
          <span class="text-xs text-slate-500 w-36 shrink-0">
            {{ field | replace('_', ' ') | title }}
          </span>
          <div class="flex-1 bg-slate-200 rounded-full h-1.5">
            <div class="bg-blue-400 h-1.5 rounded-full"
                 style="width: {{ pct }}%"></div>
          </div>
          <span class="text-xs text-slate-500 w-10 text-right">
            {{ pct }}%
          </span>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
  {% endfor %}
</div>

{# â”€â”€ Next actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="mt-8 bg-white border border-slate-200 rounded-xl p-5">
  <h2 class="font-semibold text-slate-800 mb-4">What would you like to do next?</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">

    <a href="{{ url_for('chat.chat_page', session_id=session.id) }}"
       class="flex flex-col items-center text-center p-4 border border-slate-200
              rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-colors">
      <span class="text-2xl mb-2">ğŸ’¬</span>
      <span class="text-sm font-semibold text-slate-700">Ask Questions</span>
      <span class="text-xs text-slate-500 mt-1">
        Chat with citations from your documents
      </span>
    </a>

    <a href="{{ url_for('reports.report_page', session_id=session.id) }}"
       class="flex flex-col items-center text-center p-4 border border-slate-200
              rounded-lg hover:border-green-300 hover:bg-green-50 transition-colors">
      <span class="text-2xl mb-2">ğŸ“‹</span>
      <span class="text-sm font-semibold text-slate-700">Generate Report</span>
      <span class="text-xs text-slate-500 mt-1">
        Patient summary or pharmacy summary
      </span>
    </a>

    <a href="{{ url_for('intake.intake_form', session_id=session.id) }}"
       class="flex flex-col items-center text-center p-4 border border-slate-200
              rounded-lg hover:border-slate-300 hover:bg-slate-50 transition-colors">
      <span class="text-2xl mb-2">ğŸ“</span>
      <span class="text-sm font-semibold text-slate-700">Edit Intake</span>
      <span class="text-xs text-slate-500 mt-1">
        Update symptoms and re-run matching
      </span>
    </a>

  </div>
</div>

{% else %}
{# No results state #}
<div class="text-center py-16 bg-white rounded-xl border border-dashed
            border-slate-300">
  <div class="text-5xl mb-4">ğŸ”</div>
  <h2 class="text-lg font-semibold text-slate-700 mb-1">
    No results yet
  </h2>
  <p class="text-sm text-slate-500 mb-6">
    Complete the intake form to run condition matching.
  </p>
  <a href="{{ url_for('intake.intake_form', session_id=session.id) }}"
     class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold
            px-5 py-2.5 rounded-md transition-colors">
    Go to Intake Form
  </a>
</div>
{% endif %}

{% endblock %}