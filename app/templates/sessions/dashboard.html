{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}

{# â”€â”€ Header row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold text-slate-800">Dashboard</h1>
    <p class="text-sm text-slate-500 mt-0.5">
      Welcome back, {{ current_user.email }}
    </p>
  </div>
  <a href="{{ url_for('sessions.new_session') }}"
     class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold
            px-4 py-2 rounded-md transition-colors shadow-sm">
    + New Session
  </a>
</div>


{% if followup_alerts %}
<div class="bg-amber-50 border border-amber-300 rounded-xl px-5 py-4 mb-6">
  {% for alert in followup_alerts %}
  <div class="flex items-center justify-between">
    <div>
      <p class="font-semibold text-amber-800 text-sm">
        â° Follow-up due: {{ alert.followup_date }}
      </p>
      <p class="text-xs text-amber-600">{{ alert.title }}</p>
    </div>
    <a href="{{ url_for('appointments.detail', appt_id=alert.id) }}"
       class="text-xs text-amber-700 underline font-medium">
      View â†’
    </a>
  </div>
  {% endfor %}
</div>
{% endif %}





{# â”€â”€ Session list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if sessions %}
  <div class="space-y-4">
    {% for s in sessions %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5
                hover:border-blue-300 transition-colors">
      <div class="flex items-start justify-between gap-4">

        {# Left: info #}
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <h2 class="font-semibold text-slate-800 truncate">{{ s.title }}</h2>

            {# Status badge #}
            <span class="text-xs px-2 py-0.5 rounded-full font-medium
              {% if s.status == 'intake' %}bg-slate-100 text-slate-600
              {% elif s.status == 'reviewing' %}bg-amber-100 text-amber-700
              {% elif s.status == 'results' %}bg-blue-100 text-blue-700
              {% elif s.status == 'chat' %}bg-purple-100 text-purple-700
              {% elif s.status == 'report' %}bg-green-100 text-green-700
              {% else %}bg-slate-100 text-slate-500
              {% endif %}">
              {{ s.status | capitalize }}
            </span>

            {% if s.safety_flagged %}
            <span class="text-xs px-2 py-0.5 rounded-full font-medium
                         bg-red-100 text-red-700">
              âš  Safety Flag
            </span>
            {% endif %}
          </div>

          <p class="text-xs text-slate-400 mb-3">
            Created {{ s.created_at[:10] }}
          </p>

          {# Quick stats #}
          <div class="flex gap-4 text-xs text-slate-500">
            <span>ğŸ“„ {{ s.uploads.count() }} upload{{ 's' if s.uploads.count() != 1 }}</span>
            <span>ğŸ” {{ s.disease_results.count() }} condition{{ 's' if s.disease_results.count() != 1 }}</span>
            <span>ğŸ’¬ {{ s.chat_messages.count() }} message{{ 's' if s.chat_messages.count() != 1 }}</span>
            <span>ğŸ“‹ {{ s.reports.count() }} report{{ 's' if s.reports.count() != 1 }}</span>
          </div>
        </div>

        {# Right: actions #}
        <div class="flex flex-col gap-2 shrink-0">
          <a href="{{ url_for('sessions.detail', session_id=s.id) }}"
             class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700
                    px-3 py-1.5 rounded-md transition-colors text-center">
            View
          </a>
          <a href="{{ url_for('intake.intake_form', session_id=s.id) }}"
             class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700
                    px-3 py-1.5 rounded-md transition-colors text-center">
            Edit Intake
          </a>

          {# Delete form with CSRF #}
          <form method="POST"
                action="{{ url_for('sessions.delete_session', session_id=s.id) }}"
                onsubmit="return confirm('Delete this session and all its data?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit"
                    class="w-full text-xs bg-red-50 hover:bg-red-100 text-red-600
                           px-3 py-1.5 rounded-md transition-colors">
              Delete
            </button>
          </form>
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

{% else %}
  {# Empty state #}
  <div class="text-center py-20 bg-white rounded-xl border border-dashed
              border-slate-300">
    <div class="text-5xl mb-4">ğŸ“‹</div>
    <h2 class="text-lg font-semibold text-slate-700 mb-1">No sessions yet</h2>
    <p class="text-sm text-slate-500 mb-6">
      Start by creating a new session and describing your symptoms.
    </p>
    <a href="{{ url_for('sessions.new_session') }}"
       class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold
              px-5 py-2.5 rounded-md transition-colors">
      Create Your First Session
    </a>
  </div>
{% endif %}

{% endblock %}