{% extends 'base.html' %}
{% block title %}Send to Pharmacy{% endblock %}

{% block content %}

<div class="mb-5 text-sm text-slate-500 flex items-center gap-2">
  <a href="{{ url_for('sessions.dashboard') }}"
     class="text-blue-600 hover:underline">Dashboard</a>
  <span>/</span>
  <a href="{{ url_for('reports.report_page', session_id=session.id) }}"
     class="text-blue-600 hover:underline">Reports</a>
  <span>/</span>
  <span>Send to Pharmacy</span>
</div>

<div class="max-w-lg mx-auto">

  {% if not smtp_available %}
  <div class="bg-amber-50 border border-amber-300 rounded-xl
              px-5 py-4 mb-5 text-sm text-amber-800">
    âš  Email is not configured. Add SMTP credentials to
    <code class="bg-amber-100 px-1 rounded">.env</code>
    and restart.
  </div>
  {% endif %}

  <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8">

    <h1 class="text-2xl font-bold text-slate-800 mb-1">
      ðŸ’Š Send to My Pharmacy
    </h1>
    <p class="text-sm text-slate-500 mb-6">
      Your consent is required before sending. The report will go
      directly to your saved pharmacy â€” no email address entry needed.
    </p>

    {# Saved pharmacy card #}
    <div class="bg-slate-50 border border-slate-200 rounded-lg
                px-4 py-3 mb-5">
      <p class="text-xs font-semibold text-slate-400 uppercase
                tracking-wide mb-1">Sending to</p>
      <p class="font-semibold text-slate-800">
        {{ pharmacy.pharmacy_name or 'My Pharmacy' }}
      </p>
      <p class="text-sm text-slate-500">{{ pharmacy.pharmacy_email }}</p>
      {% if pharmacy.pharmacy_address %}
      <p class="text-xs text-slate-400 mt-1">
        {{ pharmacy.pharmacy_address }}
      </p>
      {% endif %}
      <a href="{{ url_for('settings.settings') }}"
         class="text-xs text-blue-600 hover:underline mt-1 inline-block">
        Change pharmacy â†’
      </a>
    </div>

    {# What's being sent #}
    <div class="bg-slate-50 border border-slate-200 rounded-lg
                px-4 py-3 mb-5 text-sm">
      <p class="text-xs font-semibold text-slate-400 uppercase
                tracking-wide mb-1">Attachment</p>
      <p class="text-slate-700">
        ðŸ“Ž <strong>pharmacy_summary.pdf</strong> â€”
        Generated {{ report.generated_at[:10] }}
      </p>
    </div>

    <form method="POST"
          action="{{ url_for('email.consent_page', report_id=report.id) }}"
          novalidate>
      {{ form.hidden_tag() }}

      {# Reason #}
      <div class="mb-5">
        <label class="block text-xs font-semibold text-slate-500
                      uppercase tracking-wide mb-1">
          Reason for sharing <span class="text-red-500">*</span>
        </label>
        {{ form.consent_note(
             rows=3,
             class='w-full border border-slate-300 rounded-md px-3 py-2
                    text-sm text-slate-800 focus:outline-none
                    focus:ring-2 focus:ring-blue-500 resize-none',
             placeholder='e.g. Sharing with my pharmacist to review my '
                         'medications in context of my recent symptoms.'
           ) }}
        {% for error in form.consent_note.errors %}
          <p class="mt-1 text-xs text-red-600">{{ error }}</p>
        {% endfor %}
      </div>

      {# Consent checkbox #}
      <div class="bg-blue-50 border border-blue-200 rounded-lg
                  px-4 py-3 mb-5">
        <label class="flex items-start gap-3 cursor-pointer">
          {{ form.explicit_consent(
               class='mt-0.5 rounded text-blue-600
                      focus:ring-blue-500 shrink-0'
             ) }}
          <span class="text-sm text-blue-800">
            {{ form.explicit_consent.label.text }}
          </span>
        </label>
        {% for error in form.explicit_consent.errors %}
          <p class="mt-1 text-xs text-red-600">{{ error }}</p>
        {% endfor %}
      </div>

      <p class="text-xs text-slate-400 mb-5">
        ðŸ”’ Your consent and this action are recorded in the audit log.
      </p>

      <div class="flex gap-3">
        <button type="submit"
                {% if not smtp_available %}disabled{% endif %}
                class="flex-1 bg-green-600 hover:bg-green-700
                       disabled:bg-slate-300 disabled:cursor-not-allowed
                       text-white font-semibold py-2.5 px-4
                       rounded-md transition-colors text-sm">
          {% if smtp_available %}
            Send to {{ pharmacy.pharmacy_name or 'Pharmacy' }} â†’
          {% else %}
            Email Not Configured
          {% endif %}
        </button>
        <a href="{{ url_for('reports.report_page', session_id=session.id) }}"
           class="flex-1 text-center bg-slate-100 hover:bg-slate-200
                  text-slate-700 font-semibold py-2.5 px-4
                  rounded-md transition-colors text-sm">
          Cancel
        </a>
      </div>

    </form>
  </div>
</div>

{% endblock %}