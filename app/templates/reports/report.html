{% extends 'base.html' %}
{% block title %}Reports â€” {{ session.title }}{% endblock %}

{% block content %}

{# Breadcrumb #}
<div class="mb-5 text-sm text-slate-500 flex items-center gap-2">
  <a href="{{ url_for('sessions.dashboard') }}"
     class="text-blue-600 hover:underline">Dashboard</a>
  <span>/</span>
  <a href="{{ url_for('sessions.detail', session_id=session.id) }}"
     class="text-blue-600 hover:underline">{{ session.title }}</a>
  <span>/</span>
  <span>Reports</span>
</div>

<h1 class="text-2xl font-bold text-slate-800 mb-1">Generate Reports</h1>
<p class="text-sm text-slate-500 mb-6">
  Choose a report type below. Reports are informational only and
  must not be used as a substitute for professional medical advice.
</p>

{# Safety flag warning #}
{% if session.safety_flagged %}
<div class="bg-red-50 border border-red-200 rounded-lg px-4 py-3 mb-6
            text-sm text-red-700">
  âš ï¸ <strong>Safety alert was triggered</strong> during this session.
  Pharmacy report generation is disabled. Please consult emergency
  services or a healthcare professional.
</div>
{% endif %}

{# No disease results warning #}
{% if not has_diseases %}
<div class="bg-amber-50 border border-amber-200 rounded-lg px-4 py-3 mb-6
            text-sm text-amber-700">
  âš ï¸ No condition matching results found.
  <a href="{{ url_for('retrieve.results', session_id=session.id) }}"
     class="underline font-medium">Run condition matching first â†’</a>
</div>
{% endif %}

{# â”€â”€ Two report cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

  {# Patient Report #}
  <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <div class="text-2xl mb-3">ğŸ‘¤</div>
    <h2 class="text-lg font-semibold text-slate-800 mb-1">
      Patient Summary
    </h2>
    <p class="text-sm text-slate-500 mb-4">
      A plain-language summary of your symptoms, top matching conditions,
      and questions to ask your doctor. Designed for you to read and keep.
    </p>

    <ul class="text-xs text-slate-500 space-y-1 mb-5">
      <li>âœ“ Simple language, no medical jargon</li>
      <li>âœ“ Top 5 possible conditions with explanations</li>
      <li>âœ“ "When to seek urgent care" guidance</li>
      <li>âœ“ Questions to ask your doctor</li>
      <li>âœ“ Citations from your documents</li>
    </ul>

    {% if patient_report %}
    <div class="bg-green-50 border border-green-200 rounded-lg px-3 py-2
                text-xs text-green-700 mb-3">
      âœ“ Last generated: {{ patient_report.generated_at[:10] }}
    </div>
    <div class="flex gap-2">
      <form method="POST"
            action="{{ url_for('reports.generate_report', session_id=session.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="report_type" value="patient">
        <button type="submit"
                class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700
                       px-3 py-1.5 rounded-md transition-colors">
          Regenerate
        </button>
      </form>
      <a href="{{ url_for('reports.download_report', report_id=patient_report.id) }}"
         class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold
                px-3 py-1.5 rounded-md transition-colors">
        â¬‡ Download PDF
      </a>
    </div>
    {% else %}
    <form method="POST"
          action="{{ url_for('reports.generate_report', session_id=session.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="report_type" value="patient">
      <button type="submit"
              {% if not has_diseases %}disabled{% endif %}
              class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300
                     text-white font-semibold py-2 px-4 rounded-md
                     transition-colors text-sm">
        Generate Patient Report
      </button>
    </form>
    {% endif %}
  </div>

  {# Pharmacy Report #}
  <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6
              {% if session.safety_flagged %}opacity-60{% endif %}">
    <div class="text-2xl mb-3">ğŸ’Š</div>
    <h2 class="text-lg font-semibold text-slate-800 mb-1">
      Pharmacy / Clinician Summary
    </h2>
    <p class="text-sm text-slate-500 mb-4">
      A structured informational summary for sharing with a pharmacist
      or clinician. Contains reported medications, allergies, and
      top condition candidates. <strong>Not a prescription.</strong>
    </p>

    <ul class="text-xs text-slate-500 space-y-1 mb-5">
      <li>âœ“ Reported medications and allergies</li>
      <li>âœ“ Top 10 condition candidates with scores</li>
      <li>âœ“ RAG-derived document findings</li>
      <li>âœ“ Full citations and disclaimers</li>
      <li>âœ“ Can be emailed with explicit consent</li>
    </ul>

    {% if pharmacy_report %}
    <div class="bg-green-50 border border-green-200 rounded-lg px-3 py-2
                text-xs text-green-700 mb-3">
      âœ“ Last generated: {{ pharmacy_report.generated_at[:10] }}
    </div>
    <div class="flex gap-2 flex-wrap">
      <form method="POST"
            action="{{ url_for('reports.generate_report', session_id=session.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="report_type" value="pharmacy">
        <button type="submit"
                {% if session.safety_flagged %}disabled{% endif %}
                class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700
                       px-3 py-1.5 rounded-md transition-colors">
          Regenerate
        </button>
      </form>
      <a href="{{ url_for('reports.download_report', report_id=pharmacy_report.id) }}"
         class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold
                px-3 py-1.5 rounded-md transition-colors">
        â¬‡ Download PDF
      </a>
      <a href="{{ url_for('email.consent_page', report_id=pharmacy_report.id) }}"
         class="text-xs bg-green-600 hover:bg-green-700 text-white font-semibold
                px-3 py-1.5 rounded-md transition-colors">
        âœ‰ Email to Pharmacy
      </a>
    </div>
    {% else %}
    <form method="POST"
          action="{{ url_for('reports.generate_report', session_id=session.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="report_type" value="pharmacy">
      <button type="submit"
              {% if not has_diseases or session.safety_flagged %}disabled{% endif %}
              class="w-full bg-green-600 hover:bg-green-700 disabled:bg-slate-300
                     text-white font-semibold py-2 px-4 rounded-md
                     transition-colors text-sm">
        Generate Pharmacy Report
      </button>
    </form>
    {% endif %}
  </div>

</div>

{# â”€â”€ Session summary preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if has_diseases %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
  <h2 class="font-semibold text-slate-800 mb-4">ğŸ“‹ Session Summary Preview</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {# Intake #}
    <div>
      <h3 class="text-xs font-semibold text-slate-400 uppercase
                 tracking-wide mb-2">Your Intake</h3>
      <dl class="space-y-1.5 text-sm">
        {% for key, value in intake.items() %}
          {% if value %}
          <div class="flex gap-2">
            <dt class="text-slate-400 shrink-0 w-28">
              {{ key | replace('_',' ') | title }}:
            </dt>
            <dd class="text-slate-700">{{ value[:80] }}</dd>
          </div>
          {% endif %}
        {% endfor %}
      </dl>
    </div>

    {# Top conditions #}
    <div>
      <h3 class="text-xs font-semibold text-slate-400 uppercase
                 tracking-wide mb-2">Top Conditions</h3>
      <ol class="space-y-1.5">
        {% for d in diseases %}
        <li class="flex items-center justify-between text-sm">
          <span class="text-slate-700">
            <span class="text-slate-400 mr-1">#{{ d.rank }}</span>
            {{ d.disease.disease_name }}
          </span>
          <span class="text-xs text-blue-600 font-medium">
            {{ (d.similarity_score * 100) | round(1) }}%
          </span>
        </li>
        {% endfor %}
      </ol>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}